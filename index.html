<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stockholms karta â€“ cykelstrÃ¥k, kollektivtrafik & valkretsar</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: system-ui, sans-serif; }

    /* --- Tidslinje-slider --- */
    .year-slider-container {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 12px 24px 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
      text-align: center;
      min-width: 280px;
    }
    .year-slider-container label {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }
    .year-slider-container input[type=range] {
      width: 220px;
      margin: 6px 0 2px;
      accent-color: #2ca25f;
    }
    .year-ticks {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #555;
      padding: 0 2px;
    }
    .year-ticks span {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background 0.15s;
    }
    .year-ticks span:hover { background: #e5f5e0; }
    .year-ticks span.active { font-weight: 700; color: #0a7a3b; }

    /* --- Legend --- */
    .legend {
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      padding: 10px 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 12px;
      line-height: 1.6;
    }
    .legend h4 {
      margin: 0 0 6px;
      font-size: 13px;
      color: #333;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color {
      width: 20px;
      height: 14px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Tidslinje-slider -->
  <div class="year-slider-container" id="yearSliderBox">
    <label>ValÃ¥r: <strong id="yearLabel">2022</strong></label><br>
    <input type="range" id="yearSlider" min="0" max="2" step="1" value="2">
    <div class="year-ticks">
      <span data-idx="0">2014</span>
      <span data-idx="1">2018</span>
      <span data-idx="2" class="active">2022</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([59.3293, 18.0686], 12);

    const light = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 20, attribution: "&copy; OpenStreetMap &copy; CARTO" }
    ).addTo(map);

    const dark = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 20, attribution: "&copy; OpenStreetMap &copy; CARTO" }
    );

    const baseLayers = {
      "Ljus (svart/vit)": light,
      "MÃ¶rk (svart/vit)": dark
    };

    const overlays = {};
    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // --- FÃ¤rgskala: MP i procent (0..100) ---
    const colorSteps = [
      { min: 12, color: "#0a7a3b", label: "12 %+" },
      { min: 10, color: "#2ca25f", label: "10â€“12 %" },
      { min:  8, color: "#66c2a4", label: "8â€“10 %" },
      { min:  6, color: "#b2e2a4", label: "6â€“8 %" },
      { min:  4, color: "#e5f5e0", label: "4â€“6 %" },
      { min:  0, color: "#f7fcf5", label: "< 4 %" }
    ];

    function getColor(pct) {
      if (pct == null) return "#cccccc";
      for (const s of colorSteps) {
        if (pct >= s.min) return s.color;
      }
      return "#f7fcf5";
    }

    // --- Legend ---
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = '<h4>MP-stÃ¶d (riksdagsvalet)</h4>' +
        colorSteps.map(s =>
          `<div class="legend-item">
             <span class="legend-color" style="background:${s.color}"></span>
             <span>${s.label}</span>
           </div>`
        ).join("") +
        '<div class="legend-item"><span class="legend-color" style="background:#cccccc"></span><span>Data saknas</span></div>';
      return div;
    };
    legend.addTo(map);

    // --- Tidslinje-logik ---
    const years = [2014, 2018, 2022];
    const yearPropMap = {
      2014: "MP_pct_2014",
      2018: "MP_pct_2018",
      2022: "MP_pct_2022"
    };
    let currentYear = 2022;
    let valkretsLayer = null;

    const slider = document.getElementById("yearSlider");
    const yearLabel = document.getElementById("yearLabel");
    const ticks = document.querySelectorAll(".year-ticks span");

    function setYear(idx) {
      currentYear = years[idx];
      yearLabel.textContent = currentYear;
      slider.value = idx;
      ticks.forEach((t, i) => t.classList.toggle("active", i === idx));
      if (valkretsLayer) updateValkretsStyle();
    }

    slider.addEventListener("input", (e) => setYear(+e.target.value));
    ticks.forEach(t => t.addEventListener("click", () => setYear(+t.dataset.idx)));

    function updateValkretsStyle() {
      if (!valkretsLayer) return;
      valkretsLayer.eachLayer(layer => {
        const prop = yearPropMap[currentYear];
        const pct = layer.feature.properties[prop];
        layer.setStyle({
          fillColor: getColor(pct),
          fillOpacity: 0.55
        });
        // Update popup
        const f = layer.feature;
        const name = f.properties?.Vdnamn || "Valkrets";
        const lkfv = f.properties?.Lkfv || "";
        const p2014 = f.properties.MP_pct_2014;
        const p2018 = f.properties.MP_pct_2018;
        const p2022 = f.properties.MP_pct_2022;
        const fmt = (v) => v == null ? "â€”" : v.toFixed(1) + "%";
        const arrow = (a, b) => {
          if (a == null || b == null) return "";
          const diff = b - a;
          if (diff > 0.5) return ' <span style="color:#0a7a3b">&#9650;</span>';
          if (diff < -0.5) return ' <span style="color:#c0392b">&#9660;</span>';
          return ' <span style="color:#888">&#9644;</span>';
        };

        layer.setPopupContent(
          `<strong>${name}</strong><br>` +
          `<span style="color:#888;font-size:11px">Lkfv: ${lkfv}</span><br><br>` +
          `<table style="font-size:13px;border-collapse:collapse">` +
          `<tr><td style="padding:1px 8px 1px 0;font-weight:${currentYear===2014?700:400}">2014:</td><td>${fmt(p2014)}</td><td></td></tr>` +
          `<tr><td style="padding:1px 8px 1px 0;font-weight:${currentYear===2018?700:400}">2018:</td><td>${fmt(p2018)}</td><td>${arrow(p2014,p2018)}</td></tr>` +
          `<tr><td style="padding:1px 8px 1px 0;font-weight:${currentYear===2022?700:400}">2022:</td><td>${fmt(p2022)}</td><td>${arrow(p2018,p2022)}</td></tr>` +
          `</table>`
        );
      });
    }

    // HÃ¥ll koll pÃ¥ bounds
    const boundsList = [];
    function tryFitBounds() {
      if (boundsList.length === 0) return;
      const b = boundsList.reduce((acc, cur) => acc.extend(cur), boundsList[0]);
      map.fitBounds(b, { padding: [20, 20] });
    }

    // 1) Valkretsar med MP (koroplett + popup + tidslinje)
    fetch("data/valkretsar_mp.geojson")
      .then(r => r.json())
      .then(gj => {
        valkretsLayer = L.geoJSON(gj, {
          style: (f) => {
            const pct = f.properties?.MP_pct_2022;
            return {
              color: "#222",
              weight: 1,
              opacity: 0.9,
              fillColor: getColor(pct),
              fillOpacity: 0.55
            };
          },
          onEachFeature: (f, l) => {
            l.bindPopup(""); // will be set by updateValkretsStyle
            l.on("mouseover", () => l.setStyle({ fillOpacity: 0.75 }));
            l.on("mouseout",  () => l.setStyle({ fillOpacity: 0.55 }));
          }
        }).addTo(map);

        overlays["Valkretsar (MP %)"] = valkretsLayer;
        layerControl.addOverlay(valkretsLayer, "Valkretsar (MP %)");
        boundsList.push(valkretsLayer.getBounds());
        tryFitBounds();
        updateValkretsStyle(); // set popups for initial year
      })
      .catch(err => {
        console.error("Kunde inte ladda valkretsar_mp.geojson:", err);
        alert("Fel: kunde inte ladda data/valkretsar_mp.geojson");
      });

    // 2) CykelstrÃ¥k â€“ TUNNARE och lÃ¤gre opacitet, AVSTÃ„NGT som default
    fetch("data/cykelstrak_primara.geojson")
      .then(r => r.json())
      .then(gj => {
        const cykelLayer = L.geoJSON(gj, {
          style: (f) => ({
            color: "#333",
            weight: (f.properties?.Typ === "PrimÃ¤rt strÃ¥k") ? 2.5 : 1.5,
            opacity: 0.5,
            dashArray: (f.properties?.Typ === "UngefÃ¤rligt primÃ¤rt strÃ¥k") ? "6 5" : null
          }),
          onEachFeature: (f, l) => {
            const typ  = f.properties?.Typ || "StrÃ¥k";
            const ref  = f.properties?.Referens || "";
            l.bindPopup(`<strong>${typ}</strong><br>${ref}`);
          }
        });
        // Inte addTo(map) â€“ avstÃ¤ngt som default

        overlays["CykelstrÃ¥k"] = cykelLayer;
        layerControl.addOverlay(cykelLayer, "CykelstrÃ¥k");
      })
      .catch(err => console.error("Kunde inte ladda cykelstrÃ¥k:", err));

    // 3) Tunnelbana â€“ fÃ¤rgkodad per linje
    fetch("data/tunnelbana.geojson")
      .then(r => r.json())
      .then(gj => {
        const tbanaLayer = L.geoJSON(gj, {
          style: (f) => ({
            color: f.properties?.colour || "#888",
            weight: 4,
            opacity: 0.85
          }),
          onEachFeature: (f, l) => {
            const linje = f.properties?.linje || "Tunnelbana";
            l.bindPopup(`<strong>ðŸš‡ ${linje}</strong>`);
          }
        }).addTo(map);

        overlays["Tunnelbana"] = tbanaLayer;
        layerControl.addOverlay(tbanaLayer, "Tunnelbana");
      })
      .catch(err => console.error("Kunde inte ladda tunnelbana:", err));

    // 4) PendeltÃ¥g
    fetch("data/pendeltag.geojson")
      .then(r => r.json())
      .then(gj => {
        const pendelLayer = L.geoJSON(gj, {
          style: () => ({
            color: "#ec619f",
            weight: 3,
            opacity: 0.8
          }),
          onEachFeature: (f, l) => {
            const name = f.properties?.name || "PendeltÃ¥g";
            l.bindPopup(`<strong>ðŸš† ${name}</strong>`);
          }
        }).addTo(map);

        overlays["PendeltÃ¥g"] = pendelLayer;
        layerControl.addOverlay(pendelLayer, "PendeltÃ¥g");
      })
      .catch(err => console.error("Kunde inte ladda pendeltÃ¥g:", err));

    // 5) SpÃ¥rvÃ¤g & lokalbana â€“ fÃ¤rg per typ
    fetch("data/sparvag_lokalbana.geojson")
      .then(r => r.json())
      .then(gj => {
        const colorMap = {
          "SpÃ¥rvagn 7":      "#f7a600",
          "Nockebybanan 12": "#f7a600",
          "TvÃ¤rbanan 30":    "#e36012",
          "TvÃ¤rbanan 31":    "#e36012",
          "LidingÃ¶banan 21": "#b5651d",
          "SaltsjÃ¶banan":    "#7b68a4",
          "Roslagsbanan":    "#6cbe45"
        };
        const sparLayer = L.geoJSON(gj, {
          style: (f) => ({
            color: colorMap[f.properties?.typ] || "#999",
            weight: 3,
            opacity: 0.85
          }),
          onEachFeature: (f, l) => {
            const typ = f.properties?.typ || "SpÃ¥rtrafik";
            l.bindPopup(`<strong>ðŸšŠ ${typ}</strong>`);
          }
        });

        overlays["SpÃ¥rvÃ¤g & lokalbana"] = sparLayer;
        layerControl.addOverlay(sparLayer, "SpÃ¥rvÃ¤g & lokalbana");
      })
      .catch(err => console.error("Kunde inte ladda spÃ¥rvÃ¤g/lokalbana:", err));

    // 6) Stombussar (linje 1, 2, 3, 4, 6)
    fetch("data/stombuss.geojson")
      .then(r => r.json())
      .then(gj => {
        const stombussLayer = L.geoJSON(gj, {
          style: () => ({
            color: "#1a5fb4",
            weight: 3,
            opacity: 0.75
          }),
          onEachFeature: (f, l) => {
            const linje = f.properties?.linje || "Stombuss";
            l.bindPopup(`<strong>ðŸšŒ ${linje}</strong>`);
          }
        });

        overlays["Stombussar"] = stombussLayer;
        layerControl.addOverlay(stombussLayer, "Stombussar");
      })
      .catch(err => console.error("Kunde inte ladda stombussar:", err));

    // 7) Stadsdelar (extra lager, AVSTÃ„NGT frÃ¥n start)
    fetch("data/stadsdel_4326.geojson")
      .then(r => r.json())
      .then(gj => {
        const stadsdelLayer = L.geoJSON(gj, {
          style: () => ({
            color: "#555",
            weight: 1,
            opacity: 0.8,
            fillColor: "#999",
            fillOpacity: 0.06
          }),
          onEachFeature: (f, l) => {
            const name = f.properties?.NAMN || f.properties?.name || "Stadsdel";
            l.bindPopup(`<strong>${name}</strong>`);
          }
        });

        overlays["Stadsdelar"] = stadsdelLayer;
        layerControl.addOverlay(stadsdelLayer, "Stadsdelar");
      })
      .catch(err => console.error("Kunde inte ladda stadsdelar:", err));
  </script>
</body>
</html>
