<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CykelstrÃ¥k + Valkretsar + Tunnelbana + PendeltÃ¥g</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([59.3293, 18.0686], 12);

    const light = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 20, attribution: "&copy; OpenStreetMap &copy; CARTO" }
    ).addTo(map);

    const dark = L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      { subdomains: "abcd", maxZoom: 20, attribution: "&copy; OpenStreetMap &copy; CARTO" }
    );

    const baseLayers = {
      "Ljus (svart/vit)": light,
      "MÃ¶rk (svart/vit)": dark
    };

    const overlays = {};
    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // --- KoropletthjÃ¤lp: MP i procent (0..100) ---
    function getColor(pct) {
      if (pct == null) return "#cccccc";
      if (pct >= 12) return "#0a7a3b";
      if (pct >= 10) return "#2ca25f";
      if (pct >=  8) return "#66c2a4";
      if (pct >=  6) return "#b2e2a4";
      if (pct >=  4) return "#e5f5e0";
      return "#f7fcf5";
    }

    // HÃ¥ll koll pÃ¥ bounds sÃ¥ vi kan zooma â€œbraâ€ efter att lager laddats
    const boundsList = [];
    function tryFitBounds() {
      if (boundsList.length === 0) return;
      const b = boundsList.reduce((acc, cur) => acc.extend(cur), boundsList[0]);
      map.fitBounds(b, { padding: [20, 20] });
    }

    // 1) Valkretsar med MP (koroplett + popup)
    fetch("data/valkretsar_mp.geojson")
      .then(r => r.json())
      .then(gj => {
        const valkretsMP = L.geoJSON(gj, {
          style: (f) => {
            const pct = f.properties?.MP_pct; // ska vara 0..100
            return {
              color: "#222",
              weight: 1,
              opacity: 0.9,
              fillColor: getColor(pct),
              fillOpacity: 0.55
            };
          },
          onEachFeature: (f, l) => {
            const name = f.properties?.Vdnamn || "Valkrets";
            const lkfv = f.properties?.Lkfv || "";
            const pct  = f.properties?.MP_pct;
            const pctTxt = (pct == null) ? "saknas" : `${pct.toFixed(1)}%`;

            l.bindPopup(
              `<strong>${name}</strong><br>` +
              `Lkfv: ${lkfv}<br>` +
              `MP: ${pctTxt}`
            );
            l.on("mouseover", () => l.setStyle({ fillOpacity: 0.75 }));
            l.on("mouseout",  () => l.setStyle({ fillOpacity: 0.55 }));
          }
        }).addTo(map);

        overlays["Valkretsar (MP %)"] = valkretsMP;
        layerControl.addOverlay(valkretsMP, "Valkretsar (MP %)");
        boundsList.push(valkretsMP.getBounds());
        tryFitBounds();
      })
      .catch(err => {
        console.error("Kunde inte ladda valkretsar_mp.geojson:", err);
        alert("Fel: kunde inte ladda data/valkretsar_mp.geojson");
      });

    // 2) CykelstrÃ¥k (primÃ¤ra) â€“ tydligare stil
    fetch("data/cykelstrak_primara.geojson")
      .then(r => r.json())
      .then(gj => {
        const cykelLayer = L.geoJSON(gj, {
          style: (f) => ({
            color: "#111",
            weight: (f.properties?.Typ === "PrimÃ¤rt strÃ¥k") ? 5 : 3,
            opacity: 0.95,
            dashArray: (f.properties?.Typ === "UngefÃ¤rligt primÃ¤rt strÃ¥k") ? "8 6" : null
          }),
          onEachFeature: (f, l) => {
            const typ  = f.properties?.Typ || "StrÃ¥k";
            const ref  = f.properties?.Referens || "";
            l.bindPopup(`<strong>${typ}</strong><br>${ref}`);
          }
        }).addTo(map);

        overlays["CykelstrÃ¥k"] = cykelLayer;
        layerControl.addOverlay(cykelLayer, "CykelstrÃ¥k");
        boundsList.push(cykelLayer.getBounds());
        tryFitBounds();
      })
      .catch(err => console.error("Kunde inte ladda cykelstrÃ¥k:", err));

    // 3) Tunnelbana â€“ fÃ¤rgkodad per linje
    fetch("data/tunnelbana.geojson")
      .then(r => r.json())
      .then(gj => {
        const tbanaLayer = L.geoJSON(gj, {
          style: (f) => ({
            color: f.properties?.colour || "#888",
            weight: 4,
            opacity: 0.85
          }),
          onEachFeature: (f, l) => {
            const linje = f.properties?.linje || "Tunnelbana";
            l.bindPopup(`<strong>ðŸš‡ ${linje}</strong>`);
          }
        }).addTo(map);

        overlays["Tunnelbana"] = tbanaLayer;
        layerControl.addOverlay(tbanaLayer, "Tunnelbana");
      })
      .catch(err => console.error("Kunde inte ladda tunnelbana:", err));

    // 4) PendeltÃ¥g
    fetch("data/pendeltag.geojson")
      .then(r => r.json())
      .then(gj => {
        const pendelLayer = L.geoJSON(gj, {
          style: () => ({
            color: "#ec619f",
            weight: 3,
            opacity: 0.8
          }),
          onEachFeature: (f, l) => {
            const name = f.properties?.name || "PendeltÃ¥g";
            l.bindPopup(`<strong>ðŸš† ${name}</strong>`);
          }
        }).addTo(map);

        overlays["PendeltÃ¥g"] = pendelLayer;
        layerControl.addOverlay(pendelLayer, "PendeltÃ¥g");
      })
      .catch(err => console.error("Kunde inte ladda pendeltÃ¥g:", err));

    // 5) Stadsdelar (extra lager, AVSTÃ„NGT frÃ¥n start)
    fetch("data/stadsdel_4326.geojson")
      .then(r => r.json())
      .then(gj => {
        const stadsdelLayer = L.geoJSON(gj, {
          style: () => ({
            color: "#555",
            weight: 1,
            opacity: 0.8,
            fillColor: "#999",
            fillOpacity: 0.06
          }),
          onEachFeature: (f, l) => {
            const name = f.properties?.NAMN || f.properties?.name || "Stadsdel";
            l.bindPopup(`<strong>${name}</strong>`);
          }
        });

        overlays["Stadsdelar"] = stadsdelLayer;
        layerControl.addOverlay(stadsdelLayer, "Stadsdelar");
      })
      .catch(err => console.error("Kunde inte ladda stadsdelar:", err));
  </script>
</body>
</html>
